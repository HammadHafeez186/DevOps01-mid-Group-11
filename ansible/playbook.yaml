---
- name: Deploy DevOps Articles Application to Kubernetes
  hosts: eks_cluster
  gather_facts: yes
  
  vars:
    app_name: devops-articles
    k8s_namespace: devops-articles
    k8s_manifests_dir: "../k8s"
    ecr_registry: "322467327252.dkr.ecr.us-east-1.amazonaws.com"
    image_name: "devops-articles"
    image_tag: "latest"
    
  tasks:
    - name: Check if kubectl is installed
      command: kubectl version --client
      register: kubectl_check
      changed_when: false
      
    - name: Display kubectl version
      debug:
        msg: "kubectl version: {{ kubectl_check.stdout_lines[0] }}"
        
    - name: Check AWS CLI installation
      command: aws --version
      register: aws_check
      changed_when: false
      
    - name: Display AWS CLI version
      debug:
        msg: "AWS CLI version: {{ aws_check.stdout }}"
        
    - name: Configure kubectl for EKS cluster
      shell: |
        aws eks update-kubeconfig --region {{ aws_region }} --name {{ cluster_name }}
      changed_when: false
      
    - name: Create namespace if it doesn't exist
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ k8s_namespace }}"
            
    - name: Apply ConfigMap
      kubernetes.core.k8s:
        state: present
        src: "{{ k8s_manifests_dir }}/01-configmap.yaml"
        namespace: "{{ k8s_namespace }}"
        
    - name: Check if secrets exist
      kubernetes.core.k8s_info:
        kind: Secret
        name: app-secrets
        namespace: "{{ k8s_namespace }}"
      register: secret_check
      
    - name: Display secret status
      debug:
        msg: "Secrets {{ 'exist' if secret_check.resources else 'will be created automatically' }}"

    - name: Get RDS endpoint from Terraform outputs
      shell: |
        cd ../infra
        terraform output -raw rds_address 2>/dev/null || echo "devops-articles-postgres.cwjkesms8ego.us-east-1.rds.amazonaws.com"
      register: rds_endpoint
      changed_when: false
      
    - name: Get RDS password from AWS Secrets Manager
      shell: |
        SECRET_NAME=$(aws secretsmanager list-secrets --query "SecretList[?contains(Name, 'devops-articles-db-password')].Name" --output text | tail -1)
        aws secretsmanager get-secret-value --secret-id "$SECRET_NAME" --query 'SecretString' --output text | jq -r '.password'
      register: rds_password
      changed_when: false
      no_log: true

    - name: URL encode password for DATABASE_URL
      set_fact:
        encoded_password: "{{ rds_password.stdout | urlencode }}"
      no_log: true

    - name: Update ConfigMap with actual RDS endpoint
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: app-config
            namespace: "{{ k8s_namespace }}"
          data:
            NODE_ENV: "production"
            PORT: "3000"
            DB_HOST: "{{ rds_endpoint.stdout }}"
            DB_PORT: "5432"
            DB_NAME: "devops_db"
            DB_USERNAME: "postgres"
            DB_SSL: "true"
            AWS_REGION: "{{ aws_region }}"
            EMAIL_FROM: "noreply@devops-articles.com"
            APP_URL: "http://localhost:3000"
            COOKIE_SECURE: "false"
            NODE_TLS_REJECT_UNAUTHORIZED: "0"

    - name: Create or update app-secrets
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: app-secrets
            namespace: "{{ k8s_namespace }}"
          type: Opaque
          stringData:
            DB_PASSWORD: "{{ rds_password.stdout }}"
            DATABASE_URL: "postgresql://postgres:{{ encoded_password }}@{{ rds_endpoint.stdout }}:5432/devops_db?sslmode=require"
            SESSION_SECRET: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') }}"
            RESEND_API_KEY: "re_placeholder"
      no_log: true

    - name: Apply ServiceAccount
      kubernetes.core.k8s:
        state: present
        src: "{{ k8s_manifests_dir }}/09-serviceaccount.yaml"
        namespace: "{{ k8s_namespace }}"
      
    - name: Apply Application Deployment
      kubernetes.core.k8s:
        state: present
        src: "{{ k8s_manifests_dir }}/06-app-deployment.yaml"
        namespace: "{{ k8s_namespace }}"
        
    - name: Apply Application Service
      kubernetes.core.k8s:
        state: present
        src: "{{ k8s_manifests_dir }}/07-app-service.yaml"
        namespace: "{{ k8s_namespace }}"
        
    - name: Apply HPA (Horizontal Pod Autoscaler)
      kubernetes.core.k8s:
        state: present
        src: "{{ k8s_manifests_dir }}/08-hpa.yaml"
        namespace: "{{ k8s_namespace }}"
      ignore_errors: yes
      
    - name: Wait for application pods to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ k8s_namespace }}"
        label_selectors:
          - app={{ app_name }}
      register: pod_list
      until: pod_list.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0
      retries: 30
      delay: 10
      
    - name: Get deployment status
      kubernetes.core.k8s_info:
        kind: Deployment
        name: app
        namespace: "{{ k8s_namespace }}"
      register: deployment_status
      
    - name: Display deployment replicas
      debug:
        msg: "Deployment ready replicas: {{ deployment_status.resources[0].status.readyReplicas | default(0) }}/{{ deployment_status.resources[0].spec.replicas }}"
        
    - name: Get service information
      kubernetes.core.k8s_info:
        kind: Service
        name: app-service
        namespace: "{{ k8s_namespace }}"
      register: service_info
      
    - name: Display LoadBalancer URL
      debug:
        msg: "Application URL: http://{{ service_info.resources[0].status.loadBalancer.ingress[0].hostname | default('pending...') }}"
      when: service_info.resources[0].spec.type == 'LoadBalancer'
      
    - name: Get all pods
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ k8s_namespace }}"
      register: all_pods
      
    - name: Display pod status
      debug:
        msg: "Pod {{ item.metadata.name }} is {{ item.status.phase }}"
      loop: "{{ all_pods.resources }}"
      loop_control:
        label: "{{ item.metadata.name }}"
